# Build image for Raspberry Pi 4

## Prerequisites

* OS: Ubuntu 20.04 LTS (recommended)
* Packages:

```bash
sudo apt update
sudo apt install gawk wget git-core diffstat unzip texinfo gcc build-essential \
chrpath socat cpio python3 python3-pip python3-pexpect xz-utils debianutils \
iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev xterm \
python3-subunit mesa-common-dev zstd liblz4-tool
````

---

## Step 1: Setup Yocto (Kirkstone)

```bash
git clone -b kirkstone https://git.yoctoproject.org/poky
cd poky
```

---

## Step 2: Clone Meta Layers

```bash
git clone -b kirkstone https://github.com/openembedded/meta-openembedded.git
git clone -b kirkstone https://github.com/agherzan/meta-raspberrypi.git
git clone -b kirkstone https://github.com/meta-qt5/meta-qt5.git
```

---

## Step 3: Source Environment and Create Build Directory

```bash
source oe-init-build-env
```

This creates a `build/` folder and drops you into it.

---

## Step 4: Modify `conf/bblayers.conf`

Add the following layers:

```bash
# POKY_BBLAYERS_CONF_VERSION is increased each time build/conf/bblayers.conf
# changes incompatibly
POKY_BBLAYERS_CONF_VERSION = "2"

BBPATH = "${TOPDIR}"
BBFILES ?= ""

BBLAYERS ?= " \
  /home/phuc/Desktop/yocto-rpi/poky/meta \
  /home/phuc/Desktop/yocto-rpi/poky/meta-poky \
  /home/phuc/Desktop/yocto-rpi/poky/meta-yocto-bsp \
  /home/phuc/Desktop/yocto-rpi/meta-openembedded/meta-oe \
  /home/phuc/Desktop/yocto-rpi/meta-openembedded/meta-multimedia \
  /home/phuc/Desktop/yocto-rpi/meta-openembedded/meta-networking \
  /home/phuc/Desktop/yocto-rpi/meta-openembedded/meta-python \
  /home/phuc/Desktop/yocto-rpi/meta-raspberrypi \
  /home/phuc/Desktop/yocto-rpi/meta-qt5 \
  /home/phuc/Desktop/yocto-rpi/meta-myqt \
  /home/phuc/Desktop/yocto-rpi/poky/meta-phuc \
  "
```

Or use the command:

```bash
bitbake-layers add-layer ../meta-openembedded/meta-oe
bitbake-layers add-layer ../meta-openembedded/meta-python
bitbake-layers add-layer ../meta-openembedded/meta-networking
bitbake-layers add-layer ../meta-raspberrypi
bitbake-layers add-layer ../meta-qt5
```

---

## Step 5: Modify `conf/local.conf`

Edit `build/conf/local.conf`:

```bash
MACHINE = "raspberrypi4"
INIT_MANAGER = "systemd"
LICENSE_FLAGS_ACCEPTED = "synaptics-killswitch"

# Use systemd
INIT_MANAGER = "systemd"

# SSH server
EXTRA_IMAGE_FEATURES += " ssh-server-openssh"

# WiFi
IMAGE_INSTALL:append = " wpa-supplicant networkmanager iproute2"

# Enable Wayland, PAM, OpenGL stack
DISTRO_FEATURES:append = " wayland pam opengl egl gles2 kmsdrm"

# Mesa + EGL/GLES (must have EGL/Qt)
IMAGE_INSTALL:append = " mesa mesa-demos libdrm \
    libegl-mesa libgles2-mesa libgbm"

# Weston
IMAGE_INSTALL:append = " freerdp weston weston-init"

IMAGE_INSTALL:append = " qtbase qtbase-plugins qtdeclarative \
    qtquickcontrols qtquickcontrols2 qtwayland qtwayland-plugins \
    qtgraphicaleffects qtsvg"

# Your Project 
IMAGE_INSTALL:append = " project1"

PACKAGECONFIG:append:pn-qtbase = " eglfs kms"

# SD card
IMAGE_ROOTFS_SIZE ?= "2048"

PACKAGECONFIG:append:pn-weston = " rdp"

# remove NetworkManager
IMAGE_INSTALL:remove = " networkmanager"

IMAGE_INSTALL:append = " systemd-networkd"

PACKAGECONFIG:append:pn-systemd = " networkd resolved"

ENABLE_VC4GRAPHICS = "1"

# --- Enable SPI and MCP2515 CAN Controller ---
RPI_EXTRA_CONFIG:append = "\n\
dtparam=spi=on\n\
dtoverlay=mcp2515-can0,oscillator=8000000,interrupt=25,spimaxfrequency=1000000\n\
"

# Optional: include all kernel modules & CAN utilities
IMAGE_INSTALL:append = " kernel-modules can-utils iproute2 "

IMAGE_INSTALL:append = " startup"




```

---

## Step 6: Build the Image

To build a minimal core image:

```bash
bitbake core-image-minimal
```

Or to build a full-featured image with package manager and Qt:

```bash
bitbake core-image-base
```

---

## Step 7: Flash Image to SD Card

After the build completes, the image will be located here:

```bash
# image is located at build/tmp/deploy/images/raspberrypi4/
cd tmp/deploy/images/raspberrypi4
ls
```

To flash the image to an SD card:

```bash
sudo umount /dev/sda1 /dev/sda2 2>/dev/null || true
sudo bmaptool copy core-image-base-raspberrypi4-2025*.wic.bz2 /dev/sda
sync && sudo eject /dev/sda
```

---

## Step 8: Boot Raspberry Pi 4

1. Insert the SD card and power on.

2. Connect HDMI and keyboard (or UART).

3. Login with:

   ```
   root (no password)
   ```

4. Run the Qt application manually in EGLFS mode:

   ```bash
   export QT_QPA_PLATFORM=eglfs
   cd /usr/bin/your_project
   ```




