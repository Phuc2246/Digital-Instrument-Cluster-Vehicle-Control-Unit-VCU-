# Remote LAN Configuration in a Yocto Project (Raspberry Pi 4)

This guide explains how to configure a **static Ethernet network**, add a **custom startup service**, and enable **remote access** in a Yocto-based system running on **Raspberry Pi 4**.

---

## Prerequisites

* Yocto Project environment already set up
* Custom layer created (e.g. `meta-phuc`)
* Target: Raspberry Pi 4
* Systemd enabled in your image

---

## STEP 1: Create and Add a Custom Yocto Layer

Ensure your custom layer exists and is added to `bblayers.conf`:

```
/home/phuc/Desktop/yocto-rpi/poky/meta-phuc
```

Add the layer path to:

```
build/conf/bblayers.conf
```

---

## STEP 2: Configure Static Ethernet Network (systemd-networkd)

### 2.1 Create Network Configuration File

Navigate to the startup recipe files directory:

```bash
cd ~/Desktop/yocto-rpi/poky/meta-phuc/recipes-core/startup/files
```

Create the file `20-wired.network`:

```bash
nano 20-wired.network
```

**File content:**

```ini
[Match]
Name=eth0

[Network]
Address=192.168.1.100/24
Gateway=192.168.1.1
DNS=8.8.8.8
DNS=1.1.1.1
```

---

### 2.2 Create or Edit BitBake Recipe

Edit the recipe file (create it if it does not exist):

```bash
nano ~/Desktop/yocto-rpi/poky/meta-phuc/recipes-core/startup/startup_1.0.bb
```

**Full recipe content:**

```bitbake
DESCRIPTION = "Custom startup script and systemd service (CAN + Qt + Network)"
LICENSE = "CLOSED"

SRC_URI = " \
 file://my-startup.service \
 file://mystartup.sh \
 file://20-wired.network \
"

inherit systemd

S = "${WORKDIR}"

do_install() {
 # Install startup script
 install -d ${D}${bindir}
 install -m 0755 ${WORKDIR}/mystartup.sh ${D}${bindir}/mystartup.sh

 # Install systemd service unit
 install -d ${D}${systemd_system_unitdir}
 install -m 0644 ${WORKDIR}/my-startup.service ${D}${systemd_system_unitdir}/my-startup.service

 # Install systemd-networkd configuration
 install -d ${D}${sysconfdir}/systemd/network
 install -m 0644 ${WORKDIR}/20-wired.network ${D}${sysconfdir}/systemd/network/
}

FILES:${PN} += " \
 ${systemd_system_unitdir}/my-startup.service \
 ${sysconfdir}/systemd/network/20-wired.network \
"

# Enable systemd service
SYSTEMD_SERVICE:${PN} = "my-startup.service"
SYSTEMD_AUTO_ENABLE = "enable"

# Runtime dependency
RDEPENDS:${PN} += "systemd"
```

---

### 2.3 Verify Directory Structure

```bash
tree ~/Desktop/yocto-rpi/poky/meta-phuc/recipes-core/startup/
```

**Expected result:**

```
recipes-core/startup/
├── files
│   ├── my-startup.service
│   ├── mystartup.sh
│   └── 20-wired.network
└── startup_1.0.bb
```

---

## STEP 3: Build the Image

Navigate to the build directory:

```bash
cd ~/Desktop/yocto-rpi/poky/build
```

Clean and rebuild the startup recipe:

```bash
bitbake startup -c cleansstate
bitbake startup
```

Build the base image:

```bash
bitbake core-image-base
```

---

## STEP 4: Connect and Verify Network on Raspberry Pi 4

### 4.1 SSH into the Target Device

```bash
ssh root@192.168.1.100
```

Check Ethernet interface:

```bash
ip addr show eth0
```

Check routing table:

```bash
ip route
```

---

## STEP 5: Configure Static IP on Host PC (Ubuntu Example)

### 5.1 Check Existing Connections

```bash
nmcli con show
```

### 5.2 Create Static Ethernet Connection

```bash
sudo nmcli con add type ethernet ifname enp2s0 con-name eth-static \
 ipv4.addresses 192.168.1.10/24 \
 ipv4.gateway 192.168.1.1 \
 ipv4.dns "8.8.8.8" \
 ipv4.method manual
```

Activate the connection:

```bash
sudo nmcli con up eth-static
```

Verify and test:

```bash
ip addr show enp2s0
ping 192.168.1.100
ssh root@192.168.1.100
```

---

## STEP 6: Create Self-Signed Certificate for Weston

Create directory for certificates:

```bash
mkdir -p /etc/weston/certs
cd /etc/weston/certs
```

Generate a self-signed certificate:

```bash
openssl req -new -x509 -days 365 -nodes \
 -out weston.crt \
 -keyout weston.key \
 -subj "/C=VN/ST=HCM/L=HCM/O=Weston/CN=raspberrypi4"
```

Set permissions:

```bash
chmod 600 weston.key
```

---

## Result

* Raspberry Pi 4 boots with a static Ethernet IP
* Custom startup service is enabled automatically
* Remote SSH access is available
* Weston uses a self-signed certificate for secure communication

---

✅ This document is suitable for use as a **GitHub README or project documentation**.
